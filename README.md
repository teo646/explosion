# 폭발 유체 시뮬레이션

물리 단위를 기반으로 2D/3D 폭발 현상을 수치적으로 실험할 수 있는 파이토치 기반 프로젝트입니다. `stable_fluid/fluid.py`에 정의된 `Fluid` 클래스를 중심으로, 압축성 오일러 방정식과 안정화된 비압축성 단계를 조합하여 충격파·난류 구조를 캡처합니다. Jupyter Notebook에서 초기 조건을 구성하고 애니메이션을 출력할 수 있으며, 시뮬레이션 결과는 `output.mp4`, `output_fast.mp4`와 같은 예제 파일로 확인할 수 있습니다.

## 핵심 구성 요소

- `stable_fluid/fluid.py`  
  물리 단위(밀도 kg/m³, 속도 m/s, 에너지 J/m³)를 유지하면서 압축성 업데이트(`comp_step`)와 전통적인 Stable Fluids 단계(`step`)를 모두 지원하는 엔진입니다. 경계 감쇠, 보존량 검사, 라플라시안·포아송 해석기 등 수치 안정화를 위한 유틸리티가 포함되어 있습니다.

- `2d.ipynb`, `3d.ipynb`, `viewer.ipynb`  
  실험을 위한 주 노트북으로, 격자 크기·시간 간격·폭발 초기 조건을 설정하고 시각화 루프를 실행합니다. 2D 노트북에서는 가우시안 압력 분포로 폭발을 점화하고, 다단 시간 적분으로 결과를 애니메이션으로 저장합니다.

- `polyline_control/polyline.py`  
  벡터장을 따라 폴리라인을 운송하거나 균일 아크 길이로 재분포하는 도구입니다. 가시화를 위한 유동선 추적에 사용할 수 있습니다.

- `output.mp4`, `output_fast.mp4`  
  예제 시뮬레이션 결과. 실험 없이도 모델이 생성하는 유동 특성을 미리 확인할 수 있습니다.

- `debug/25-11-*.txt`  
  반복 실험 중 기록한 파라미터와 관찰 로그를 모아둔 디버깅 노트입니다.

## 물리 및 수치 모델

- **압축성 단계 (`Fluid.comp_step`)**  
  보존형 오일러 방정식을 중앙차분으로 적분합니다. 질량·운동량·에너지 플럭스를 계산해 각 셀을 업데이트하며, 음수 밀도/에너지 또는 NaN이 발생하면 즉시 예외를 발생시킵니다. 모든 계산은 실제 단위를 유지하도록 설계되었습니다.

- **비압축성 안정화 (`Fluid.step`)**  
  세미라그랑지안 이동 후 압력 투영을 수행하는 Stable Fluids 단계입니다. 소용돌이 강화를 위한 `vorticity_confinement_2d/3d`가 포함되어 있으며, 경계 감쇠 마스크로 외곽 진동을 억제합니다.

- **보조 기능**  
  FFT 기반 포아송 해석기, 스칼라장 그라디언트/라플라시안, 단기간 내 수치 폭주를 방지하기 위한 `clamp_with_tolerance` 등을 제공합니다.

## 실행 방법

1. **환경 준비**
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install torch numpy matplotlib perlin-noise ipykernel
   ```
   GPU 가속을 사용하려면 CUDA가 포함된 PyTorch 빌드를 설치하세요. 노트북 실행에는 Jupyter(또는 VS Code/PyCharm의 노트북 지원)가 필요합니다.

2. **노트북 실행**
   ```bash
   jupyter notebook
   ```
   `explosion/2d.ipynb` 또는 `explosion/3d.ipynb`를 열고 상단 셀부터 실행합니다. 초기 조건(격자 간격 `dx`, 시간 간격 `COMP_DT`, 폭발 반경 등)을 필요에 맞게 수정하세요.

3. **시뮬레이션 워크플로**
   - 초기화: 주변 상태를 `rho_ambient`, `p_ambient`로 채우고 폭발 영역에 높은 압력/에너지를 부여합니다.
   - 시간 적분: 압축성 단계(`comp_step`)와 비압축성 단계(`step`)를 교대로 호출합니다. 외부 힘(부력, 소용돌이 강화)을 원하는 타이밍에 적용할 수 있습니다.
   - 출력: 애니메이션 프레임을 `matplotlib.animation.FuncAnimation` 등으로 렌더링하여 MP4로 저장하거나, 노트북 내에서 실시간으로 미리 보기합니다.

4. **성과 확인**  
   `output_fast.mp4`는 시간 스케일을 압축한 버전, `output.mp4`는 표준 속도 버전입니다. 자체 실험 후 결과를 비교하거나 새로운 설정을 추가로 기록할 수 있습니다.

## 디버깅과 기록

- 보존량이 크게 벗어나면 `Fluid._check_validity`가 예외를 발생합니다. 메시지를 확인하고 시간 간격이나 초기 조건을 조정하세요.
- `debug/` 디렉터리에 실험별 로그를 저장해 파라미터 변화에 따른 결과를 추적할 수 있습니다.

## 향후 개선 아이디어

- 충격면을 더 명확하게 보존하기 위한 고차 upwind/flux limiter 도입
- 열전도 또는 방사 모델과의 결합
- 다중 폭발 소스 또는 경계 조건 커스터마이징을 위한 도구화
- Polyline 시각화를 위한 추가 UI (예: ipywidgets 기반 컨트롤러)

시뮬레이션이 정상적으로 동작하지 않거나 물리 모델 확장이 필요하다면 `stable_fluid/fluid.py`의 관련 함수를 참조하여 수정하세요.

